name: Scheduled Release

on:
  schedule:
    - cron: '0 0 * * 1'   # Every Monday at 00:00 UTC — patch bump
    - cron: '0 0 1 * *'   # 1st of every month at 00:00 UTC — minor bump
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor

permissions:
  contents: write

jobs:
  scheduled-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine bump type
        id: bump
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.bump }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event.schedule }}" = "0 0 1 * *" ]; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
          else
            # Weekly cron — but skip if today is the 1st (monthly cron handles it)
            if [ "$(date +%d)" = "01" ]; then
              echo "type=skip" >> "$GITHUB_OUTPUT"
              echo "Skipping weekly run on the 1st — monthly cron handles this."
            else
              echo "type=patch" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Release modules with changes
        if: steps.bump.outputs.type != 'skip'
        run: |
          BUMP="${{ steps.bump.outputs.type }}"
          RELEASED=""

          for MODULE in go jvm python rust; do
            TAG_PREFIX="testcontainers-${MODULE}/v"

            # Find latest tag for this module
            LATEST_TAG=$(git tag -l "${TAG_PREFIX}*" --sort=-v:refname | head -n1)

            if [ -z "$LATEST_TAG" ]; then
              echo "==> [$MODULE] No existing tag, starting from 0.0.0"
              CURRENT="0.0.0"

              # Skip if the module directory doesn't exist
              if [ ! -d "testcontainers-${MODULE}" ]; then
                echo "==> [$MODULE] Directory does not exist, skipping."
                continue
              fi
            else
              CURRENT="${LATEST_TAG#${TAG_PREFIX}}"
              echo "==> [$MODULE] Latest tag: ${LATEST_TAG} (version: ${CURRENT})"

              # Check for changes since last tag
              CHANGES=$(git diff --name-only "${LATEST_TAG}" HEAD -- "testcontainers-${MODULE}/")
              if [ -z "$CHANGES" ]; then
                echo "==> [$MODULE] No changes since ${LATEST_TAG}, skipping."
                continue
              fi
              echo "==> [$MODULE] Changes detected:"
              echo "$CHANGES"
            fi

            # Parse and bump version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            if [ "$BUMP" = "minor" ]; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi
            NEXT="${MAJOR}.${MINOR}.${PATCH}"
            TAG="testcontainers-${MODULE}/v${NEXT}"
            echo "==> [$MODULE] Bumping ${CURRENT} -> ${NEXT} (${BUMP})"

            # Update version file (Go is tag-only)
            case "$MODULE" in
              jvm)
                sed -i "s/^version = '.*'/version = '${NEXT}'/" testcontainers-jvm/build.gradle
                git add testcontainers-jvm/build.gradle
                git diff --cached --quiet || git commit -m "chore(jvm): bump version to ${NEXT}"
                ;;
              python)
                sed -i "s/^version = \".*\"/version = \"${NEXT}\"/" testcontainers-python/pyproject.toml
                git add testcontainers-python/pyproject.toml
                git diff --cached --quiet || git commit -m "chore(python): bump version to ${NEXT}"
                ;;
              rust)
                sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"${NEXT}"'"/}' testcontainers-rust/Cargo.toml
                git add testcontainers-rust/Cargo.toml
                git diff --cached --quiet || git commit -m "chore(rust): bump version to ${NEXT}"
                ;;
              go)
                echo "==> [go] Tag-only versioning, no file to update."
                ;;
            esac

            # Push version bump commit (if any)
            git push origin main

            # Create and push tag (triggers release.yml)
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"

            RELEASED="${RELEASED} ${TAG}"
            echo "==> [$MODULE] Released ${TAG}"
            echo ""
          done

          if [ -z "$RELEASED" ]; then
            echo "No modules had changes. Nothing released."
          else
            echo "Released tags:${RELEASED}"
          fi
